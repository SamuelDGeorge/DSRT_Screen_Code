---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/sdgeo/Dropbox/Own/Programming/DSRT_Analysis/DSRT_Screen_Code')
library(dplyr)
library(tidyr)
library(synergyfinder)
library(nplr)
library(RColorBrewer)
library(ggplot2)
```
This function will do the following 3 things on the directory defined above:
  1) It will transform data from the template "combination response template" found in the 'shared' folder within the Der lab drive
      *Note - this function takes two arguments
          Argument 1 (x) is the .csv file within the directory to extract the information. This can be raw data OR normalized.
          Argument 2 (y) is the type of response, either "viability" or "inhibition"
              If y = viability, then the function normalizes to the drugA = 0 and drugB = 0 condition
              If y = inhibition, then the function does not attempt to normalize
              
  2) It will then fit an n-parameter logistic curve to the data using DrugB as a factor, make a subdirectory titled "logistic curves", and print the       plots. 
    **NOTE** n- can be an integer value from 1-5 and needs to be specified. When n=4, there is no 'hill coefficient' or 'correction factor', when 
      n = 5 a 'hill coeffecient' or 'correction factor' will be applied
      This function takes two arguments
        Argument 1 (x) is the output from the function above (below named 'data_frames')
        Argument 2 (y) is the integer value used to calculate the logistic function
        
  3) Lastly, it will calculate (1) a synergy matrix, create a directory named ("synergy_profile") and (2) plot the data there, and finally (3)           calculate a 'synergy score' averaging all values across the synergy matrix and save the values as a .csv file
  
This chunk will grab all files within the specified directory that are .csv files, and load the functions.
```{r Getting the file list, include=FALSE}
files <- list.files(pattern = "csv$")
sapply(list.files(pattern="[.]R$", path="C:/Users/sdgeo/Dropbox/Own/Programming/DSRT_Analysis/DSRT_Screen_Code/", full.names=TRUE), source)
```

This chunk will transform the data frames
  Arguments:
    x = .csv files to read in
    y = "viability" or "inhibition"
    z = Do you want to normalize? "YES" or "NO"
        For viability - normalize = (response/control well)*100 (i.e. when DrugA and DrugB = 0)
        For inhibition - normalize = (response - max)/(max-min)
```{r data frame transform, include=FALSE}
source("C:/Users/sdgeo/Dropbox/Own/Programming/DSRT_Analysis/DSRT_Screen_Code/Scripts/Proliferation_analysis_final_list_function.R")
data_frames <- lapply(files, final_list_method,y="inhibition", z="YES")
```

This chunk will calculate and plot the logistic functions of the comibination
  Arguments:
    x = transformed data frames from above
    y = integer (1-5) for n-parameter logistic function, or choose "all" to fit the best one
      *NOTE* If it gives an error that 'non-finite values supplied to nlm' use either "all" or a lower integer
    z = "YES" or "NO" to print the inflection point graphs
```{r logistic curves, include=FALSE}
source("C:/Users/sdgeo/Dropbox/Own/Programming/DSRT_Analysis/DSRT_Screen_Code/Scripts/logistic_fitting_function.R")
lapply(data_frames, logistic_function, y="all", z="YES")
```

This chunk will make the 3D synergy plots and write the average synergy scores for each file in /synergy_profiles
  Arguments:
    x = transformed data frames from above
    y = "HSA", "Loewe", "Bliss", or "ZIP" synergy method *ZIP combines the assumptions of both Loewe and Bliss models*
```{r synergy plots, message=TRUE, warning=TRUE, include=FALSE}
scores <- sapply(data_frames, synergy_analysis, y = "Bliss")
```

This chunk will clear the memory and restart r. Required for plotting synergy maps
```{r}
write.csv(unlist(scores), file = "synergy_profiles/synergy_scores.csv")
rm(list=ls(all=TRUE))
gc()
.rs.restartR()
```



