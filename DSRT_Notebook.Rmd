---
title: "DSRT Notebook"
output: html_notebook
---

R Notebook for displaying the DSRT Screen data and relevant analysis. 

Import the neccesary functions:
```{r}
source("Utilities/Utility_package.R")
source("Scripts/Drug_Synergy_Package.R")
```


Import the data:

```{r}
growth_effect_matrix = import_plate_range("Sample_Data/Sample_Excel_Template.xlsx", "N10:X16")
print(growth_effect_matrix)
```


Print Heatmap Scaled:
```{r}
print_heatmap_bliss_scaled(growth_effect_matrix, export_name = "Sample_Output/Sample_Output_Scaled_Heatmap.jpg", xlabel = "Drug A", ylabel = "Drug B")
```

Print Heatmap Outlier:
```{r}
print_heatmap_bliss_outlier_elim(growth_effect_matrix, 
                                 export_name = "Sample_Output/Sample_Output_Outlier_Heatmap.jpg", 
                                 xlabel = "Drug A", ylabel = "Drug B")
```

Pipeline Print Heatmap:
Here we will show how to Analyze all the XLSX files in a single folder using the Pipeline utility.
This version analyzes the files sequentially on one CPU

```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = toString(paste(getwd(),"/Sample_Pipeline_Output",sep = ""))
pipeline(pipelined_print_heatmap_growth_scaled,
         input_directory, 
         output_directory,
         additional_args = c("N10:X16")) 
```

This version runs the same analysis, but in parallel on all available CPU cores. Analyzes one sheet per core. 
```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = toString(paste(getwd(),"/Sample_Pipeline_Output",sep = ""))
pipeline(pipelined_print_heatmap_growth_scaled,
         input_directory, 
         output_directory,
         additional_args = c("N10:X16"),
         parallel_run = TRUE,
         environment = lsf.str()) 
```

Calculate a bliss sum in a couple of different ways:
```{r}
bliss_sum_scaled = calculate_bliss_sum_scaled(growth_effect_matrix)
bliss_sum_outlier = calculate_bliss_sum_outlier_elim(growth_effect_matrix)
print(bliss_sum_scaled)
print(bliss_sum_outlier)
```

Produce a .csv file with bliss sums for all items inside of a folder. Note, must be done sequentially since all sums point to the same file.
Very fast to produce however. 
```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = toString(paste(getwd(),"/Sample_Bliss_Sum",sep = ""))
pipeline(pipelined_print_bliss_sum_growth_scaled,
         input_directory, 
         output_directory,
         additional_args = c("N10:X16","Bliss_Sum_Scaled.csv")) 
```


Run Analysis on all files of a certain type within a directory. Note that the directory is created dynamically if it doesn't exit. 
```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = toString(paste(getwd(),"/Sample_Recursive_Output",sep = ""))
pipeline_folder_recursive(pipelined_print_heatmap_growth_scaled,
                          input_directory,
                          output_directory,
                          additional_args = c("N10:X16"),
                          file_type = "xlsx",
                          parallel_run = TRUE,
                          cores = 8,
                          environment = lsf.str())
```

Note, if you would like to put the sample data next to the output, just use the same input and output directory. This is given below:
```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = input_directory
pipeline_folder_recursive(pipelined_print_heatmap_growth_scaled,
                          input_directory,
                          output_directory,
                          additional_args = c("N10:X16"),
                          file_type = "xlsx",
                          parallel_run = TRUE,
                          cores = 8,
                          environment = lsf.str())
```

Run all analysis and place the files into a main folder that contains all the nested files.
Can run in parallel or sequentially. Note only the analysis in individual folders is run in parallel
```{r}
input_directory = toString(paste(getwd(),"/Sample_Data",sep = ""))
output_directory = toString(paste(getwd(),"/Sample_Recursive_Combined",sep = ""))
pipeline_folder_combine(pipelined_print_heatmap_growth_outlier_elim,
                          input_directory,
                          output_directory,
                          additional_args = c("N10:X16"),
                          file_type = "xlsx",
                          parallel_run = FALSE,
                          cores = 8,
                          environment = lsf.str())
```
